import streamlit as st
import pandas as pd
import numpy as np

# é¡µé¢é…ç½®
st.set_page_config(page_title="å…³å¡å®¡è®¡ V1.1", layout="wide")
st.title("ğŸ´ Tripeaks å…³å¡ä½“éªŒè‡ªåŠ¨åŒ–å®¡è®¡ç³»ç»Ÿ V1.1")

# 1. æ ¸å¿ƒå®¡è®¡å‡½æ•° (ä¸¥æ ¼éµå¾ª V1.1 é€»è¾‘)
def audit_logic(row, init_score):
    try:
        seq = [int(x) for x in str(row['å…¨éƒ¨è¿å‡»ï¼ˆæ¯å¼ æ‰‹ç‰Œçš„è¿å‡»æ•°ï¼‰']).split(',')]
    except: return 0, "æ‹’ç»", "åºåˆ—æ ¼å¼é”™è¯¯"
    
    desk_init = row['åˆå§‹æ¡Œé¢ç‰Œ']
    score = init_score
    reasons = []

    # --- çº¢çº¿åˆ¤å®š ---
    max_c = max(seq)
    if max_c >= desk_init * 0.4:
        return 0, "æ‹’ç»", f"çº¢çº¿ï¼šæ•°å€¼å´©å(Max:{max_c})"
    
    # è¿ç»­æ€§è®¡ç®—
    con_list = []
    cur = 0
    for x in seq:
        if x > 0: cur += 1
        else:
            if cur > 0: con_list.append(cur)
            cur = 0
    if cur > 0: con_list.append(cur)
    max_con = max(con_list) if con_list else 0

    if max_con >= 7: return 0, "æ‹’ç»", "çº¢çº¿ï¼šè‡ªåŠ¨åŒ–å±€(L3)"
    if max_c < 3: return 0, "æ‹’ç»", "çº¢çº¿ï¼šå…¨å±€æ¯ç«­"

    # --- æŠ‘åˆ¶é¡¹åˆ¤å®š (L2 > L1 äº’æ–¥) ---
    if 5 <= max_con <= 6:
        score -= 20
        reasons.append("L2è¿‡åº¦æŠ•å–‚")
    elif con_list.count(4) >= 3:
        score -= 10
        reasons.append("L1é«˜é¢‘æŠ•å–‚")

    # --- æŠ‘åˆ¶é¡¹åˆ¤å®š (3çº§ > 2çº§ > 1çº§ äº’æ–¥) ---
    for i in range(len(seq) - 3):
        window = seq[i:i+4]
        if len(window) >= 4 and window.count(0) >= 2:
            p = -25 if i <= 2 else -20
            score += p
            reasons.append(f"3çº§æ¯ç«­" + ("(å¼€å±€)" if i <= 2 else ""))
            break 
        elif len(window) >= 3:
            w3 = window[:3]
            if 1 <= w3.count(0) <= 2:
                score -= 12
                reasons.append("2çº§é˜»å¡")
                break
            elif all(0 < x <= 2 for x in w3):
                score -= 5
                reasons.append("1çº§å¹³åº¸")
                break

    # --- åŠ åˆ†é¡¹ ---
    if sum(seq[:3]) >= 4: score += 5
    if any(x >= 3 for x in seq[-5:]): score += 5
    if max_c in seq[6:]: score += 5

    return score, "é€šè¿‡", "|".join(reasons) if reasons else "æ­£å¸¸"

# 2. ä¾§è¾¹æ 
with st.sidebar:
    st.header("å‚æ•°é…ç½®")
    init_val = st.slider("åˆå§‹åˆ†", 0, 100, 60)
    uploaded_file = st.file_uploader("ä¸Šä¼ è·‘å…³ Excel/CSV", type=["xlsx", "csv"])

# 3. ä¸»é€»è¾‘
if uploaded_file:
    df = pd.read_excel(uploaded_file) if "xlsx" in uploaded_file.name else pd.read_csv(uploaded_file)
    
    # è¿è¡Œå®¡è®¡
    res = df.apply(lambda r: pd.Series(audit_logic(r, init_val)), axis=1)
    df[['å¾—åˆ†', 'ç»“æœ', 'åŸå› ']] = res
    
    # æ±‡æ€»
    summary = df.groupby(['è§£é›†ID', 'éš¾åº¦']).agg(
        Î¼=('å¾—åˆ†', 'mean'),
        Ïƒ2=('å¾—åˆ†', 'var'),
        çº¢çº¿ç‡=('ç»“æœ', lambda x: (x == "æ‹’ç»").mean())
    ).reset_index()
    
    summary['å‡†å…¥'] = summary.apply(lambda r: "âœ…" if r['Î¼']>=50 and r['Ïƒ2']<=15 and r['çº¢çº¿ç‡']<0.15 else "âŒ", axis=1)

    st.subheader("ğŸ“Š å‡†å…¥æ±‡æ€»ç»“è®º")
    st.dataframe(summary)
    
    st.subheader("ğŸ“ è¯¦ç»†å®¡è®¡æ˜ç»†")
    st.dataframe(df[['è§£é›†ID', 'æµ‹è¯•è½®æ¬¡', 'éš¾åº¦', 'å¾—åˆ†', 'ç»“æœ', 'åŸå› ']])
